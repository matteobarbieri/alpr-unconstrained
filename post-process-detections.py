import os

import argparse

import json

from utils import guess_last_frame

def parse_args():

    parser = argparse.ArgumentParser()

    parser.add_argument(
        'input_folder',
        help="The folder containing the original input images.")

    parser.add_argument(
        'aux_folder',
        help="The folder containing auxiliary files generated by the "
        "pipeline.")

    parser.add_argument(
        '--start_frame',
        type=int,
        default=1,
        help="The starting frame.")

    parser.add_argument(
        '--end_frame',
        type=int,
        # required=True,
        help="The ending frame.")

    parser.add_argument(
        '--width',
        type=int,
        help="The width of the original image")

    parser.add_argument(
        '--height',
        type=int,
        help="The height of the original image")

    args = parser.parse_args()
    if args.end_frame is None:
        args.end_frame = guess_last_frame(args.input_folder)

    return args


def process_annotations(annotations):
    pass


def area(a, b):  # returns None if rectangles don't intersect

    ax, ay, aw, ah = a
    bx, by, bw, bh = b

    # dx = min(a.xmax, b.xmax) - max(a.xmin, b.xmin)
    # dy = min(a.ymax, b.ymax) - max(a.ymin, b.ymin)

    dx = min(ax + aw, bx + bw) - max(ax, bx)
    dy = min(ay + ah, by + bh) - max(ay, by)

    if dx >= 0 and dy >= 0:
        return dx * dy


def duplicate_license_exists(p, uid, plates, ignore_car_ids):
    """
    Check if there is another license plate from a different vehicle with the
    same extracted text.
    """

    for v_id, op in plates:

        # Skip already removed cars
        if v_id in ignore_car_ids:
            continue

        # if op['plate_text'] == p['plate_text'] and uid != v_id:
        if area(p['bounding_box'], op['bounding_box']) is not None \
                and uid != v_id:
            return True

    return False


def remove_duplicate_license(car, plates, ignore_car_ids):
    new_plates_list = list()

    for p in car['plates']:

        if not duplicate_license_exists(p, car['uid'], plates, ignore_car_ids):
        # if (car['uid'], p['plate_text']) not in [  # noqa
                # (uid, op['plate_text']) for (uid, op) in plates]:

            new_plates_list.append(p)
        else:
            ignore_car_ids.append(car['uid'])

    car['plates'] = new_plates_list


def remove_duplicates(annotations):

    plates = list()

    uid = 1

    for c in annotations['cars']:
        c['uid'] = uid
        plates.extend([(uid, p) for p in c['plates']])
        uid += 1

    # List of cleaned up cars
    cars = list()

    ignore_car_ids = list()

    for c in annotations['cars']:

        # Make a copy of the annotation for a single car
        c_copy = dict(c)


        # if len(c_copy['plates']) <= 1:
            # cars.append(c_copy)
        # else:
            # remove_duplicate_license(c_copy, plates)
            # cars.append(c_copy)

        remove_duplicate_license(c_copy, plates, ignore_car_ids)

        cars.append(c_copy)

    annotations_unique = dict()
    annotations_unique['cars'] = cars

    return annotations_unique


def main():

    args = parse_args()

    for t in range(args.start_frame, args.end_frame+1):

        annotations_file = os.path.join(
            args.aux_folder,
            "frame{:05d}_annotations.json".format(t))

        # Load annotations from json file
        with open(annotations_file, 'r') as jf:
            annotations = json.load(jf)

        N_before = sum([len(c['plates']) for c in annotations['cars']])

        # Remove duplicate coming from overlapping vehicles/large BB
        annotations_unique = remove_duplicates(annotations)

        N_after = sum([len(c['plates']) for c in annotations_unique['cars']])

        print("License plates BEFORE pruning: {}".format(N_before))
        print("License plates AFTER pruning: {}".format(N_after))

        # Process annotations
        # TODO disable for now
        # process_annotations(annotations_unique)

        annotations_unique_file = os.path.join(
            args.aux_folder,
            "frame{:05d}_annotations_unique.json".format(t))

        # Load annotations from json file
        with open(annotations_unique_file, 'w') as jf:
            annotations = json.dump(annotations_unique, jf, indent=4)


if __name__ == "__main__":
    main()
